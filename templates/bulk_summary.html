{% extends "base.html" %}

{% block title %}Bulk Leave Summary - Leave Management{% endblock %}

{% block content %}
<div class="row no-print">
    <div class="col-md-12">
        <div class="card mb-3">
            <div class="card-header">
                <h6><i class="fas fa-users"></i> Bulk Leave Summary</h6>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="employee_list" class="form-label">Employee Numbers (comma separated) *</label>
                            <textarea class="form-control" id="employee_list" name="employee_list" rows="3" 
                                      placeholder="Example: 1001, 1002, 1003" required>{{ employee_list or '' }}</textarea>
                            <small class="text-muted">Enter employee numbers separated by commas</small>
                        </div>
                        <div class="col-md-3">
                            <label for="as_on_date" class="form-label">As on Date *</label>
                            <input type="date" class="form-control" id="as_on_date" name="as_on_date" 
                                   value="{{ as_on_date.strftime('%Y-%m-%d') if as_on_date else '' }}" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search"></i> Generate Reports
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if bulk_results %}
<!-- Export Controls -->
<div class="card mb-3 no-print">
    <div class="card-body py-2">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h6 class="mb-0">
                    <i class="fas fa-file-alt"></i> 
                    Bulk Summary Report - As on {{ as_on_date.strftime('%d-%m-%Y') }}
                </h6>
                <small class="text-muted">{{ bulk_results|length }} employees processed</small>
            </div>
            <div class="col-md-4 text-end">
                <button onclick="exportToPDF()" class="btn btn-danger btn-sm">
                    <i class="fas fa-file-pdf"></i> Export to PDF
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Individual Employee Reports -->
<div id="employee-reports">
    {% for result in bulk_results %}
    <div class="employee-report page-break" data-employee="{{ result.emp_no }}">
        {% if result.get('error') %}
        <!-- Error Case -->
        <div class="card border-danger mb-4">
            <div class="card-header bg-danger text-white">
                <h6 class="mb-0">
                    <i class="fas fa-exclamation-triangle"></i> {{ result.emp_no }} - Error
                </h6>
            </div>
            <div class="card-body">
                <p class="text-danger mb-0">{{ result.error }}</p>
            </div>
        </div>
        {% else %}
        <!-- Success Case - Individual Summary Layout -->
        <div class="card mb-4">
            <div class="card-body p-3">
                <!-- Report Header -->
                <div class="report-header text-center mb-3">
                    <h5 class="fw-bold mb-2">UNITED INDIA INSURANCE COMPANY LIMITED - HEAD OFFICE</h5>
                    <p class="mb-2">Leave details of <strong>{{ result.emp_name }}</strong>, EmpNo: <strong>{{ result.emp_no }}</strong> as on <strong>{{ as_on_date.strftime('%d-%m-%Y') }}</strong></p>
                    <p class="mb-3">Employee Status: {{ result.emp_status }}</p>
                </div>

                <!-- Line 1: Opening Balances and PL Accrued -->
                <div class="balance-row mb-2">
                    <table class="table table-sm table-borderless mb-2">
                        <tr>
                            <td>
                                <strong>Opening PL:</strong> 
                                {{ result.opening_balances.pl }} + {{ result.opening_balances.pl_part }}/11
                            </td>
                            <td>
                                <strong>{% if result.emp_status == 'Probationer' %}Accrued CL:{% else %}Opening CL:{% endif %}</strong> {{ result.opening_balances.cl }}
                            </td>
                            <td>
                                <strong>Opening SL:</strong> {{ result.opening_balances.sl }}
                            </td>
                            <td>
                                <strong>PL Accrued:</strong> {{ result.other_details.accrued_pl_full }} + {{ result.other_details.accrued_pl_part }}/11
                            </td>
                            <td>
                                <strong>Cumulative LOP:</strong> {{ result.opening_balances.cumulative_lop|default(0) }}
                            </td>
                        </tr>
                    </table>
                </div>

                <!-- Line 2: Used Balances, LOP, Maternity, Encashment -->
                <div class="balance-row mb-2">
                    <table class="table table-sm table-borderless mb-2">
                        <tr>
                            <td>
                                <strong>PL Used:</strong> {{ result.used_balances.pl }}
                            </td>
                            <td>
                                <strong>CL Used:</strong> {{ result.used_balances.cl }}
                            </td>
                            <td>
                                <strong>SL Used:</strong> {{ result.used_balances.sl }}
                            </td>
                            <td>
                                <strong>LOP:</strong> {{ result.other_details.lop_days }}
                            </td>
                            <td>
                                <strong>Maternity:</strong> {{ result.other_details.mat_leave }}
                            </td>
                            <td>
                                <strong>Encashment:</strong> {{ result.other_details.encashments }}
                            </td>
                        </tr>
                    </table>
                </div>

                <!-- Leave Details Table -->
                {% if result.leave_details %}
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead class="table-light">
                            <tr class="text-center">
                                <th>Sl. No.</th>
                                <th>From</th>
                                <th>To</th>
                                <th>Session</th>
                                <th>Type</th>
                                <th>SL Type</th>
                                <th>Days</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for leave in result.leave_details %}
                            <tr class="text-center">
                                <td>{{ leave.sl_no }}</td>
                                <td>{{ leave.lv_from }}</td>
                                <td>{{ leave.lv_to if leave.lv_to else leave.lv_from }}</td>
                                <td>{{ leave.session if leave.session else '' }}</td>
                                <td>{{ leave.type }}</td>
                                <td>{{ leave.sl_type if leave.sl_type else '' }}</td>
                                <td>{{ leave.days }}</td>
                                <td class="text-start">{{ leave.reason if leave.reason else '' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}

                <!-- Line 3: Closing Balances -->
                <div class="balance-row mt-2 mb-2">
                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <td>
                                <strong>Closing PL:</strong> 
                                <span class="{% if result.closing_balances.pl < 0 %}text-danger fw-bold{% endif %}">
                                    {{ result.closing_balances.pl }} + {{ result.closing_balances.pl_part }}/11
                                </span>
                            </td>
                            <td>
                                <strong>Closing CL:</strong> 
                                <span class="{% if result.closing_balances.cl < 0 %}text-danger fw-bold{% endif %}">
                                    {{ result.closing_balances.cl }}
                                </span>
                            </td>
                            <td>
                                <strong>Closing SL:</strong> 
                                <span class="{% if result.closing_balances.sl < 0 %}text-danger fw-bold{% endif %}">
                                    {{ result.closing_balances.sl }}
                                </span>
                            </td>
                            <td>
                                <strong>Closing RH:</strong> 
                                <span class="{% if result.closing_balances.rh < 0 %}text-danger fw-bold{% endif %}">
                                    {{ result.closing_balances.rh }}
                                </span>
                            </td>
                        </tr>
                    </table>
                </div>

                <!-- Warning for negative balances -->
                {% set has_negative = (result.closing_balances.pl < 0) or (result.closing_balances.cl < 0) or (result.closing_balances.sl < 0) or (result.closing_balances.rh < 0) %}
                {% if has_negative %}
                <div class="alert alert-warning mt-3 py-2">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>Warning:</strong> Employee has NEGATIVE leave balance(s). Please review leave transactions.
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
function exportToPDF() {
    window.print();
}
</script>

<style>
/* Report styling */
.report-header h5 {
    font-size: 14px;
    font-weight: bold;
}

.report-header p {
    font-size: 13px;
}

.balance-row table {
    font-size: 12px;
}

.balance-row td {
    padding: 4px 8px;
    white-space: nowrap;
}

.table-bordered {
    border: 1px solid #000;
}

.table-bordered th,
.table-bordered td {
    border: 1px solid #000;
    padding: 6px 8px;
    font-size: 12px;
}

.table-bordered thead {
    background-color: #f0f0f0;
}

.text-danger {
    color: #dc3545 !important;
}

.fw-bold {
    font-weight: bold !important;
}

/* Print styles - One page per employee */
@media print {
    .no-print, .btn, .navbar, .card-header {
        display: none !important;
    }

    .employee-report {
        page-break-after: always;
        page-break-inside: avoid;
    }

    .employee-report:last-child {
        page-break-after: auto;
    }

    .card {
        border: none !important;
        box-shadow: none !important;
        margin-bottom: 0 !important;
    }

    body {
        font-size: 12px;
    }

    .table-bordered {
        border: 1px solid #000 !important;
    }

    .table-bordered th,
    .table-bordered td {
        border: 1px solid #000 !important;
        font-size: 11px;
        padding: 4px;
    }

    .alert {
        border: 1px solid #000;
        background-color: #fff !important;
    }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .balance-row table {
        font-size: 10px;
    }

    .table-bordered th,
    .table-bordered td {
        font-size: 10px;
        padding: 4px;
    }
}
</style>
{% endblock %}
